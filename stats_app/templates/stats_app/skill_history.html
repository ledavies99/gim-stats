{% extends "base.html" %}
{% load static %}

{% block title %}{{ skill_name|title }} History{% endblock %}

{% block content %}
<main class="history-container">
    <div class="d-flex justify-content-center w-100">
        <div class="chart-card">
            <div class="text-end mb-2">
                <a href="{% url 'player_stats' %}" class="btn btn-sm btn-secondary">&laquo; Back to Stats</a>
            </div>

            <div id="player-selection" class="mb-3">
                <h4>Select Players</h4>
                {% for player in all_players %}
                <div class="form-check form-check-inline">
                    <input class="form-check-input player-checkbox" type="checkbox" value="{{ player.player_name }}" id="player_{{ player.player_name }}" {% if player.player_name == selected_player_name %}checked{% endif %}>
                    <label class="form-check-label" for="player_{{ player.player_name }}">{{ player.player_name }}</label>
                </div>
                {% endfor %}
            </div>

            <h2 id="chart-title"></h2>
            <div class="chart-container">
                <canvas id="historyChart"></canvas>
            </div>
            <div id="message-container" style="display: none;">
                </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- Elements ---
    const chartTitleEl = document.getElementById('chart-title');
    const chartCanvas = document.getElementById('historyChart');
    const updateBtn = document.getElementById('update-chart-btn');

    // --- Chart State ---
    const skillName = '{{ skill_name }}';
    const formattedSkillName = skillName.charAt(0).toUpperCase() + skillName.slice(1);
    let historyChart = null; // To hold the chart instance
    const chartColors = ['#ffd700', '#3498db', '#e74c3c', '#2ecc71', '#9b59b6', '#f1c40f'];

    // --- Dynamic Titles ---
    chartTitleEl.textContent = `${formattedSkillName} XP Over Time`;
    const yAxisTitle = 'XP';

    // --- Main Function ---
    async function fetchAndRenderChart() {
        const selectedCheckboxes = document.querySelectorAll('.player-checkbox:checked');
        const selectedPlayers = Array.from(selectedCheckboxes).map(cb => cb.value);

        if (selectedPlayers.length === 0) {
            if (historyChart) historyChart.destroy(); // Clear chart if no players are selected
            // You could show a message here
            return;
        }

        const playerQueryString = selectedPlayers.join(',');
        const apiUrl = `/api/history_data/${skillName}/?players=${playerQueryString}`;

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            // Prepare datasets for Chart.js
            const datasets = data.datasets.map((dataset, index) => ({
                label: dataset.label,
                data: dataset.data,
                borderColor: chartColors[index % chartColors.length], // Cycle through colors
                backgroundColor: 'transparent',
                tension: 0.1,
            }));

            // Destroy the old chart before drawing a new one
            if (historyChart) {
                historyChart.destroy();
            }

            // Create the new chart
            historyChart = new Chart(chartCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.timestamps,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: { display: true, text: yAxisTitle, color: '#e0e0e0' },
                            ticks: { color: '#e0e0e0' },
                            grid: { color: '#5a5752' }
                        },
                        x: {
                            title: { display: true, text: 'Timestamp', color: '#e0e0e0' },
                            ticks: { color: '#e0e0e0' },
                            grid: { color: '#5a5752' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    }
                }
            });

        } catch (error) {
            console.error('Error fetching or rendering chart:', error);
            // Display an error message to the user
        }
    }

    // --- Event Listeners ---
    const playerCheckboxes = document.querySelectorAll('.player-checkbox');

    playerCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', fetchAndRenderChart);
    });

    document.addEventListener('DOMContentLoaded', () => {
        const initiallyChecked = document.querySelector('.player-checkbox:checked');
        if (initiallyChecked) {
            fetchAndRenderChart();
        }
    });

</script>
{% endblock %}