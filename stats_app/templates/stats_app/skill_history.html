{% extends "base.html" %}
{% load static %}

{% block title %}{{ skill_name|title }} History{% endblock %}

{% block content %}
<main class="history-container">
    <div class="d-flex justify-content-center w-100">
        <div class="chart-card">
            <div class="text-end mb-2">
                <a href="{% url 'player_stats_view' %}" class="btn btn-sm btn-secondary">&laquo; Back to Stats</a>
            </div>

            <div id="player-selection" class="mb-3">
                <h4>Select Players</h4>
                <!-- All selection box -->
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="player_all">
                    <label class="form-check-label" for="player_all"><strong>All</strong></label>
                </div>
                {% for player in all_players %}
                <div class="form-check form-check-inline">
                    <input class="form-check-input player-checkbox" type="checkbox" value="{{ player.player_name }}" id="player_{{ forloop.counter }}" {% if player.player_name|lower == selected_player_name|lower %}checked{% endif %}>
                    <label class="form-check-label" for="player_{{ forloop.counter }}">{{ player.player_name }}</label>
                </div>
                {% endfor %}
            </div>

            <div class="d-flex mb-3 align-items-center" style="gap: 1rem;">
                <!-- XP/Level toggle buttons-->
                <div id="y-mode-selection">
                    <div class="btn-group" role="group" aria-label="Y-Axis Mode">
                        <button type="button" class="btn btn-sm btn-outline-primary y-mode-btn" data-mode="xp">XP</button>
                        <button type="button" class="btn btn-sm btn-outline-primary y-mode-btn active" data-mode="level">Level</button>
                    </div>
                </div>
                <!-- Show/Hide Points toggle buttons-->
                <div id="point-style-selection">
                    <div class="btn-group" role="group" aria-label="Point Style">
                        <button type="button" class="btn btn-sm btn-outline-primary point-style-btn" data-mode="show">Show Points</button>
                        <button type="button" class="btn btn-sm btn-outline-primary point-style-btn active" data-mode="hide">Hide Points</button>
                    </div>
                </div>
            </div>

            <h2 id="chart-title"></h2>
            <div class="chart-container">
                <canvas id="historyChart"></canvas>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    // --- Elements ---
    let chartTitleEl, chartCanvas, playerCheckboxes, yModeBtns, pointStyleBtns;

    // --- Chart State ---
    const skillName = '{{ skill_name }}';
    let historyChart = null;
    let yMode = 'level'; // Default to 'level'
    let pointStyle = 'hide'; // Default to 'hide'
    const chartColors = ['#ffd700', '#3498db', '#e74c3c', '#2ecc71', '#9b59b6', '#f1c40f'];

    // --- Dynamic Titles ---
    const formattedSkillName = skillName.charAt(0).toUpperCase() + skillName.slice(1);

    // --- Chart Title Update ---
    function updateChartTitle() {
        if (yMode === 'level') {
            chartTitleEl.textContent = (skillName === 'overall')
                ? 'Total Level Over Time'
                : `${formattedSkillName} Level Over Time`;
        } else {
            chartTitleEl.textContent = (skillName === 'overall')
                ? 'Total XP Over Time'
                : `${formattedSkillName} XP Over Time`;
        }
    }

    function humanizeNumber(value) {
        value = Number(value);
        if (value >= 1_000_000_000_000) return (value / 1_000_000_000_000).toFixed(1) + 'T';
        if (value >= 1_000_000_000) return (value / 1_000_000_000).toFixed(1) + 'B';
        if (value >= 1_000_000) return (value / 1_000_000).toFixed(1) + 'M';
        if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
        return value;
    }

    // --- Main Function ---
    async function fetchAndRenderChart() {
        updateChartTitle();

        const selectedCheckboxes = document.querySelectorAll('.player-checkbox:checked');
        const selectedPlayers = Array.from(selectedCheckboxes).map(cb => cb.value);

        if (selectedPlayers.length === 0) {
            if (historyChart) historyChart.destroy();
            return;
        }

        const playerQueryString = selectedPlayers.join(',');
        const apiUrl = `/api/history_data/${skillName}/?players=${playerQueryString}&ymode=${yMode}`;

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();

            if (!data || !data.datasets) {
                if (historyChart) historyChart.destroy();
                return;
            }

            // Map data to XP or Level
            const pointRadius = pointStyle === 'show' ? 3 : 0;
            const datasets = data.datasets.map((dataset, index) => ({
                label: dataset.label,
                data: dataset.data,
                borderColor: chartColors[index % chartColors.length],
                backgroundColor: 'transparent',
                tension: 0.1,
                pointRadius: pointRadius,
                pointHoverRadius: pointRadius ? 6 : 0,
            }));

            if (historyChart) historyChart.destroy();

            // X-axis label
            const unit = 'day';
            const displayFormat = 'MMM d';

            // Y-axis label
            const yAxisTitle = yMode === 'level'
                ? 'Level'
                : 'XP';

            historyChart = new Chart(chartCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: { display: true, text: yAxisTitle, color: '#e0e0e0' },
                            ticks: {
                                color: '#e0e0e0',
                                callback: function(value) {
                                    if (yMode === 'xp') {
                                        return humanizeNumber(value);
                                    }
                                    // Only show integer ticks for level
                                    return Number.isInteger(value) ? value : null;
                                }
                            },
                            grid: { color: '#5a5752' }
                        },
                        x: {
                            type: 'time',
                            time: {
                                unit: unit,
                                displayFormats: {
                                    [unit]: displayFormat,
                                }
                            },
                            title: { display: true, text: 'Date', color: '#e0e0e0' },
                            ticks: {
                                color: '#e0e0e0',
                                callback: function(value, index, ticks) {
                                    const date = new Date(value);
                                    return date.toLocaleString('en-US', { month: 'short', day: 'numeric' });
                                }
                            },
                            grid: { color: '#5a5752' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    }
                }
            });

        } catch (error) {
            console.error('Error fetching or rendering chart:', error);
        }
    }

    // --- Event Listeners ---
    function setupChartEventListeners() {
        const allCheckbox = document.getElementById('player_all');

        // "All" checkbox logic
        allCheckbox.addEventListener('change', () => {
            playerCheckboxes.forEach(cb => {
                cb.checked = allCheckbox.checked;
            });
            fetchAndRenderChart();
        });

        playerCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const allChecked = Array.from(playerCheckboxes).every(cb => cb.checked);
                allCheckbox.checked = allChecked;
                fetchAndRenderChart();
            });
        });

        yModeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                yModeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                yMode = btn.dataset.mode;
                updateChartTitle();
                fetchAndRenderChart();
            });
        });

        pointStyleBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                pointStyleBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                pointStyle = btn.dataset.mode;
                fetchAndRenderChart();
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        chartTitleEl = document.getElementById('chart-title');
        chartCanvas = document.getElementById('historyChart');
        playerCheckboxes = document.querySelectorAll('.player-checkbox');
        yModeBtns = document.querySelectorAll('.y-mode-btn');
        pointStyleBtns = document.querySelectorAll('.point-style-btn');

        // Set default active buttons for Level and Hide Points
        yModeBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === 'level');
        });
        pointStyleBtns.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === 'hide');
        });

        updateChartTitle();
        setupChartEventListeners();

        // Set "All" checkbox if all players are checked on load
        const allCheckbox = document.getElementById('player_all');
        const allChecked = Array.from(playerCheckboxes).every(cb => cb.checked);
        allCheckbox.checked = allChecked;

        const initiallyChecked = document.querySelector('.player-checkbox:checked');
        if (initiallyChecked) {
            fetchAndRenderChart();
        }
    });
</script>
{% endblock %}
